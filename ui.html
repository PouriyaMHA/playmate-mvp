<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PlayMate BF - Matchmaking</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
      color: #e5e7eb;
    }

    .page {
      max-width: 1100px;
      margin: 32px auto;
      padding: 0 16px 32px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-weight: 800;
      font-size: 14px;
    }

.lang-grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:8px;
  margin-bottom: 12px;
}

.lang-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border:1px solid #1f2937;
  border-radius:12px;
  background:#020617;
  cursor:pointer;
  font-size:13px;
  color:#e5e7eb;
}

.lang-item input{
  width:auto;
  margin:0;
}





    .header-title {
      font-size: 26px;
      font-weight: 700;
    }

    .header-sub {
      margin-top: 2px;
      font-size: 13px;
      color: #9ca3af;
    }

    .layout {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 18px;
      padding: 18px 20px;
      border: 1px solid #1f2933;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    .card-left {
      flex: 1.1;
      min-width: 0;
    }

    .card-right {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      max-height: 520px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .field-row {
      display: flex;
      gap: 10px;
    }

    .field-row > div {
      flex: 1;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 12px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input::placeholder {
      color: #6b7280;
    }

    input:focus, select:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px #6366f1;
      background: #020617;
    }

    .btn-primary {
      background: #22c55e;
      border: none;
      padding: 10px 24px;
      border-radius: 999px;
      color: #020617;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 18px 40px rgba(22, 163, 74, 0.45);
      transition: transform 0.12s, box-shadow 0.12s, background 0.12s;
    }

    .btn-primary:hover {
      background: #16a34a;
      transform: translateY(-1px);
      box-shadow: 0 22px 50px rgba(22, 163, 74, 0.5);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 10px 25px rgba(22, 163, 74, 0.4);
    }

     .btn-primary:disabled {
  opacity: 0.55;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

#profileResetBtn:disabled,
#refreshSquadBtn:disabled {
  opacity: 0.55;
  cursor: not-allowed;
  pointer-events: none;
}




    .tip {
      margin-left: 12px;
      font-size: 11px;
      color: #9ca3af;
    }

    .matches-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .matches-title {
      font-size: 15px;
      font-weight: 600;
    }

    .matches-count {
      font-size: 12px;
      color: #9ca3af;
    }

    .matches-status {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .matches-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
    }

    .match-card {
      background: #020617;
      border-radius: 14px;
      padding: 10px 12px 10px;
      border: 1px solid #1f2937;
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: flex-start;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #22c55e, #4ade80);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-weight: 800;
      font-size: 14px;
    }

    .match-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .match-name-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .match-name {
      font-weight: 600;
      font-size: 14px;
    }

    .badge-small {
      font-size: 11px;
      padding: 1px 7px;
      border-radius: 999px;
      background: #0b1120;
      border: 1px solid #1f2937;
      color: #9ca3af;
    }

    .match-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }

    .badge-soft {
      background: #020617;
      color: #9ca3af;
    }

    .match-score {
      font-size: 14px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      min-width: 52px;
      text-align: center;
    }

    .match-score.good {
      background: rgba(22, 163, 74, 0.1);
      border-color: rgba(22, 163, 74, 0.5);
      color: #4ade80;
    }

    .match-score.medium {
      background: rgba(234, 179, 8, 0.1);
      border-color: rgba(234, 179, 8, 0.6);
      color: #eab308;
    }

    .match-score.low {
      background: rgba(248, 113, 113, 0.08);
      border-color: rgba(248, 113, 113, 0.5);
      color: #f97373;
    }

    .reasons {
      grid-column: 1 / span 3;
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
    }

    .reasons-title {
      font-weight: 600;
      margin-bottom: 2px;
      color: #e5e7eb;
    }

    .reasons ul {
      margin: 0;
      padding-left: 16px;
    }

    .reasons li {
      margin-bottom: 2px;
    }

    .match-actions {
      grid-column: 1 / span 3;
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }

    .like-btn {
      background: #22c55e;
      border: none;
      padding: 5px 12px;
      border-radius: 999px;
      color: #020617;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    .like-btn:hover {
      background: #16a34a;
    }

    .like-btn:disabled {
      opacity: 0.7;
      cursor: default;
    }
    .squad-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      margin-bottom: 6px;
    }

    .squad-title {
      font-size: 14px;
      font-weight: 600;
    }

    .squad-status {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .squad-list {
      max-height: 200px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .squad-card {
      background: #020617;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid #1f2937;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
    }

    .squad-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .squad-name {
      font-weight: 600;
      font-size: 13px;
    }

    .squad-tag {
      font-size: 11px;
      color: #9ca3af;
    }

    .squad-pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #22c55e;
      white-space: nowrap;
    }

    .squad-refresh-btn {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
    }

    .squad-refresh-btn:hover {
      background: #111827;
    }

	    .swipe-section {
      margin-top: 18px;
      padding-top: 12px;
      border-top: 1px solid #111827;
    }

    .swipe-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .swipe-title {
      font-size: 14px;
      font-weight: 600;
    }

    .swipe-status {
      font-size: 11px;
      color: #9ca3af;
    }

    .swipe-card-box {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px 12px;
      margin-bottom: 8px;
      min-height: 72px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .swipe-main-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .swipe-name {
      font-weight: 600;
      font-size: 14px;
    }

    .swipe-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      font-size: 11px;
    }

    .swipe-small {
      font-size: 11px;
      color: #9ca3af;
    }

    .swipe-actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .swipe-btn-skip,
    .swipe-btn-like {
      flex: 1;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid #1f2937;
    }

    .swipe-btn-skip {
      background: #020617;
      color: #e5e7eb;
    }

    .swipe-btn-skip:hover {
      background: #111827;
    }

    .swipe-btn-like {
      background: #22c55e;
      color: #020617;
      box-shadow: 0 12px 25px rgba(22, 163, 74, 0.35);
      border-color: #16a34a;
    }

    .swipe-btn-like:hover {
      background: #16a34a;
    }

    .swipe-empty {
      font-size: 11px;
      color: #6b7280;
      padding: 4px 2px;
    }

	    .swipe-btn-skip:disabled,
    .swipe-btn-like:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .swipe-btn-skip:disabled {
      background: #020617;
      color: #6b7280;
    }

    .swipe-btn-like:disabled {
      background: #16a34a;
      color: #022c22;
    }


    .match-card.top-pick {
      border-color: rgba(34, 197, 94, 0.7);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4), 0 16px 40px rgba(22, 163, 74, 0.4);
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.08), #020617);
    }

    .top-pick-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }



    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }
      .card-right {
        max-height: none;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="header">
    <div class="logo-circle">PM</div>
    <div>
      <div class="header-title">PlayMate BF</div>
      <div class="header-sub">
        Find Battlefield teammates by region, mode, class, language and mic — then upgrade later for more games.
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: PROFILE FORM -->
    <div class="card card-left">
      <div class="card-title">Your Battlefield profile</div>
      <div class="card-sub">Fill this once, then we'll search for the best squadmates for you.</div>

      <form id="matchForm">
        <label for="username">PlayMate username</label>
        <input id="username" placeholder="Pouriya" required />

        <div class="small" id="profileStatus">
          New profile – fill in your details and click “Find matches”.
        </div>
        <button type="button" id="profileResetBtn" style="margin: 6px 0 10px; font-size: 11px; padding: 4px 10px; border-radius: 999px; border: 1px solid #374151; background: #020617; color: #9ca3af; cursor: pointer;">
          Reset profile
        </button>


        <div class="field-row">
  <div>
    <label for="region">Region</label>
<select id="region" required>
  <option value="">Select region...</option>
</select>

<label for="city">City</label>
<select id="city" required disabled>
  <option value="">Select city...</option>
</select>


  </div>
</div>

<div class="field-row">
  <div>
    <label for="platform">Platform (optional)</label>
    <select id="platform">
      <option value="">Any</option>
      <option value="PC">PC</option>
      <option value="PS5">PS5</option>
      <option value="Xbox">Xbox</option>
    </select>
  </div>
  <div>
    <label for="in_game_username">Battlefield username (hidden until mutual)</label>
    <input id="in_game_username" placeholder="e.g. BF_Pouriya" />
  </div>
</div>


        <div class="field-row">
          <div>
            <label for="favorite_mode">Favorite mode</label>
            <select id="favorite_mode" required>
              <option value="">Select mode...</option>
              <option value="Conquest">Conquest</option>
              <option value="Rush">Rush</option>
              <option value="Breakthrough">Breakthrough</option>
              <option value="TDM">Team Deathmatch</option>
	<option value="Redsec">Redsec</option>
            </select>
          </div>
          <div>
            <label for="class_type">Class</label>
            <select id="class_type" required>
              <option value="">Select class...</option>
              <option value="assault">assault</option>
              <option value="engineer">engineer</option>
              <option value="support">support</option>
              <option value="recon">recon</option>
            </select>
          </div>
        </div>

        <div class="field-row">
          <div>
            <label for="mic">Mic / Chat</label>
            <select id="mic" required>
              <option value="">Select...</option>
              <option value="voice">Voice</option>
              <option value="text">Text</option>
              <option value="both">Both</option>
              <option value="none">None</option>
            </select>
          </div>
          <div>

<label for="languagesMulti">Languages</label>

<!-- این input فقط برای نگه داشتن CSV نهایی است و در payload استفاده می‌شود -->
<input id="languages" type="hidden" value="" />

<!-- UI multi-select -->
<div id="languagesMulti" class="lang-grid"></div>

<div class="small" style="margin-top:6px; color:#9ca3af;">
  Select all languages you can speak. Matching will score higher if at least one overlaps.
</div>

          </div>
        </div>

        <div style="display:flex; align-items:center; margin-top:4px;">
          <button type="submit" class="btn-primary" id="findMatchesBtn">Find matches</button>

          <div class="tip">
            Tip: we’ll match on <span style="color:#22c55e;">region &amp; mode</span> first, then class, mic and languages.
          </div>
        </div>
      </form>
    </div>

    <!-- RIGHT: MATCHES -->
    <div class="card card-right">
      <div class="matches-header">
        <div class="matches-title">Matches</div>
        <div class="matches-count" id="matchesCount">No matches yet</div>
      </div>
      <div class="matches-status" id="statusText">
        Fill your profile and click <b>Find matches</b> to see your best Battlefield squadmates.
      </div>
      <div class="matches-list" id="matchesList"></div>
	
	      <!-- SWIPE MODE SECTION -->
      <div class="swipe-section">
        <div class="swipe-header">
          <div class="swipe-title">Swipe mode (beta)</div>
          <div class="swipe-status" id="swipeStatus">
            Run a match search, then swipe through your top picks.
          </div>
        </div>
        <div id="swipeCard"></div>
        <div class="swipe-actions">
          <button type="button" class="swipe-btn-skip" id="swipeSkipBtn">
            Skip
          </button>
          <button type="button" class="swipe-btn-like" id="swipeLikeBtn">
            Add to squad
          </button>
        </div>
      </div>


      <!-- MY SQUAD SECTION -->
      <div class="squad-header">
        <div class="squad-title">My Squad (mutual likes)</div>
        <button type="button" class="squad-refresh-btn" id="refreshSquadBtn">
          Refresh
        </button>
      </div>
      <div class="squad-status" id="squadStatus">
        Mutual likes will appear here once you and other players add each other.
      </div>
      <div class="squad-list" id="squadList"></div>

    </div>
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", () => {

      const STORAGE_KEY = "playmate_profile_v1";
    const form = document.getElementById("matchForm");


  if (!form) {
    console.error('matchForm not found. Check <form id="matchForm">');
    return;
  }

const findMatchesBtn = document.getElementById("findMatchesBtn");

const GAME = "battlefield";

const regionEl = document.getElementById("region");
const cityEl = document.getElementById("city");
const favoriteModeEl = document.getElementById("favorite_mode");

const languagesMultiEl = document.getElementById("languagesMulti");
const languagesHiddenEl = document.getElementById("languages");

let META = null;


    const matchesList = document.getElementById("matchesList");
    const statusText = document.getElementById("statusText");
    const matchesCount = document.getElementById("matchesCount");
    const profileStatus = document.getElementById("profileStatus");
    const profileResetBtn = document.getElementById("profileResetBtn");

let isSubmitting = false;

const findMatchesBtnOriginalText = findMatchesBtn ? findMatchesBtn.textContent : "Find matches";

function lockSubmitUI() {
  isSubmitting = true;

  if (findMatchesBtn) {
    findMatchesBtn.disabled = true;
    findMatchesBtn.textContent = "Searching...";
  }

  if (profileResetBtn) profileResetBtn.disabled = true;
  if (refreshSquadBtn) refreshSquadBtn.disabled = true;
}

function unlockSubmitUI() {
  isSubmitting = false;

  if (findMatchesBtn) {
    findMatchesBtn.disabled = false;
    findMatchesBtn.textContent = findMatchesBtnOriginalText;
  }

  if (profileResetBtn) profileResetBtn.disabled = false;
  if (refreshSquadBtn) refreshSquadBtn.disabled = false;
}


    // state برای swipe
    let swipeMatches = [];
    let swipeIndex = 0;

    const swipeCard = document.getElementById("swipeCard");
    const swipeStatus = document.getElementById("swipeStatus");
    const swipeSkipBtn = document.getElementById("swipeSkipBtn");
    const swipeLikeBtn = document.getElementById("swipeLikeBtn");

    let likedUsers = new Set();

    const squadList = document.getElementById("squadList");
    const squadStatus = document.getElementById("squadStatus");
    const refreshSquadBtn = document.getElementById("refreshSquadBtn");



function setProfileStatus(text) {
  profileStatus.textContent = text;
}

function setSquadStatus(text) {
  squadStatus.textContent = text;
}

function setMatchesStatus(text) {
  statusText.innerHTML = text;
}


// ---------- API helpers (Phase 2) ----------
function classifyError(err) {
  const msg = (err && err.message) ? err.message : String(err || "");
  const isAbort = err && (err.name === "AbortError");
  const isNetwork = /network|failed to fetch|fetch|cors|timeout/i.test(msg) || isAbort;
  return {
    kind: isAbort ? "timeout" : (isNetwork ? "network" : "unknown"),
    message: msg
  };
}

async function fetchJson(url, options = {}, timeoutMs = 12000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const res = await fetch(url, { ...options, signal: controller.signal });

    // تلاش برای خواندن body (حتی در خطا)
    let data = null;
    try { data = await res.json(); } catch (_) { data = null; }

    if (!res.ok) {
      const detail =
        (data && (data.detail || data.error || data.message)) ?
        (data.detail || data.error || data.message) :
        "HTTP " + res.status;
      const err = new Error(detail);
      err.httpStatus = res.status;
      err.data = data;
      throw err;
    }

    return data;
  } finally {
    clearTimeout(id);
  }
}

function setMatchesStatus(text) {
  statusText.innerHTML = text;
}



     function fillFormFromProfile(profile) {
      if (!profile) return;

      if (profile.username) {
        document.getElementById("username").value = profile.username;
      }
      if (profile.region) {
  regionEl.value = profile.region;          // region = regionId مثل "na-west"
  populateCitiesForRegion(regionEl.value);  // cities را بر اساس region پر کن
}
      if (profile.platform !== undefined) {
        document.getElementById("platform").value = profile.platform || "";
      }
      if (profile.favorite_mode) {
        document.getElementById("favorite_mode").value = profile.favorite_mode;
      }
      if (profile.class_type) {
        document.getElementById("class_type").value = profile.class_type;
      }
      if (profile.mic) {
        document.getElementById("mic").value = profile.mic;
      }
      if (profile.languages !== undefined) {
  setLanguagesChecked(profile.languages);   // languages = "en,fa"
}
         if (profile.city) {
  cityEl.value = profile.city;              // city = "Vancouver"
}
if (profile.in_game_username !== undefined) {
  document.getElementById("in_game_username").value = profile.in_game_username || "";
}


    }
  
    // تلاش برای لود پروفایل ذخیره‌شده از localStorage
        (async function init() {
  // 1) meta first (dropdown ها باید قبل از set کردن value آماده باشند)
  try {
  await loadMeta();
} catch (err) {
  console.error("Meta load error:", err);

  // Disable inputs to prevent broken submissions
  if (regionEl) regionEl.disabled = true;
  if (cityEl) cityEl.disabled = true;
  if (favoriteModeEl) favoriteModeEl.disabled = true;

  setMatchesStatus(
    "Failed to load form options. Please refresh the page. " +
    "If the issue persists, the server may be unavailable."
  );
}


  // 2) load saved profile after meta
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const profile = JSON.parse(saved);
      fillFormFromProfile(profile);

      if (profile.username) {
        setProfileStatus(
          `Profile loaded for "${profile.username}". You can update fields or click "Find matches".`
        );
        loadLikes(profile.username);
        loadSquad(profile.username);
      }
    } else {
      setProfileStatus('New profile — fill in your details and click "Find matches".');
    }
  } catch (e) {
    console.error("Error loading profile from storage:", e);
    setProfileStatus('New profile — fill in your details and click "Find matches".');
  }
})();



function setSelectOptions(selectEl, options, placeholderText) {
  selectEl.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = placeholderText || "Select...";
  selectEl.appendChild(ph);

  options.forEach((opt) => {
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    selectEl.appendChild(o);
  });
}

function buildLanguagesMulti(languages) {
  languagesMultiEl.innerHTML = "";

  languages.forEach((lang) => {
    const label = document.createElement("label");
    label.className = "lang-item";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = lang.code;

    const span = document.createElement("span");
    span.textContent = lang.label;

    cb.addEventListener("change", syncLanguagesHidden);

    label.appendChild(cb);
    label.appendChild(span);
    languagesMultiEl.appendChild(label);
  });

  // initial sync
  syncLanguagesHidden();
}

function syncLanguagesHidden() {
  const checked = Array.from(languagesMultiEl.querySelectorAll('input[type="checkbox"]:checked'))
    .map((x) => x.value.trim().toLowerCase())
    .filter(Boolean);

  languagesHiddenEl.value = checked.join(",");
}

function setLanguagesChecked(csv) {
  const set = new Set(
    (csv || "")
      .split(",")
      .map((x) => x.trim().toLowerCase())
      .filter(Boolean)
  );

  Array.from(languagesMultiEl.querySelectorAll('input[type="checkbox"]')).forEach((cb) => {
    cb.checked = set.has(cb.value.toLowerCase());
  });

  syncLanguagesHidden();
}

function findRegionById(regionId) {
  if (!META || !META.regions) return null;
  return META.regions.find((r) => r.id === regionId) || null;
}

function populateCitiesForRegion(regionId) {
  const r = findRegionById(regionId);

  if (!r) {
    cityEl.disabled = true;
    setSelectOptions(cityEl, [], "Select city...");
    return;
  }

  const cityOptions = (r.cities || []).map((c) => ({ value: c, label: c }));
  cityEl.disabled = false;
  setSelectOptions(cityEl, cityOptions, "Select city...");
}

regionEl.addEventListener("change", () => {
  populateCitiesForRegion(regionEl.value);
});





async function loadMeta() {
  const res = await fetch(`/api/meta/${encodeURIComponent(GAME)}`, { cache: "no-store" });
  if (!res.ok) throw new Error("Failed to load options (HTTP " + res.status + ")");

  const json = await res.json();

  // اگر سرور به هر دلیل error برگردوند، ساکت خالی نذار
  if (json && json.error) {
    throw new Error(json.error);
  }

  META = json;

  // Regions
  const regionOptions = (META.regions || []).map((r) => ({ value: r.id, label: r.label }));
  setSelectOptions(regionEl, regionOptions, "Select region...");

  // Favorite modes
  const modeOptions = (META.favorite_modes || []).map((m) => ({ value: m, label: m }));
  setSelectOptions(favoriteModeEl, modeOptions, "Select mode...");

  // Languages multi-select
  buildLanguagesMulti(META.languages || []);

  // City depends on region
  cityEl.disabled = true;
  setSelectOptions(cityEl, [], "Select city...");

  // اگر meta خالی بود، به کاربر بگو مشکل داریم
  if (!regionOptions.length) {
    setMatchesStatus("Form options failed to load. Please refresh the page.");
  }
}


 function scoreClass(score) {
      if (score >= 80) return "good";
      if (score >= 50) return "medium";
      return "low";
    }

   async function loadLikes(username) {
  likedUsers = new Set();
  if (!username) return;

  try {
    const data = await fetchJson(
      "/api/my-likes?username=" + encodeURIComponent(username),
      {},
      12000
    );

    const arr = (data && data.liked_users) ? data.liked_users : [];
    arr.forEach((name) => {
      if (name) likedUsers.add(name);
    });

  } catch (err) {
    // Fail-safe: اگر لایک‌ها نیومدند، فقط log کن و ادامه بده
    const info = classifyError(err);
    console.error("loadLikes failed:", info.kind, info.message, err);
  }
}




    // ---------- رندر مچ‌ها ----------
    function renderMatches(matches) {
      matchesList.innerHTML = "";

      if (!matches || !matches.length) {
        matchesCount.textContent = "No matches";
        return;
      }

      matchesCount.textContent = `Found ${matches.length} matches`;

      // تعیین Top picks: ۳ تا اولی که حداقل ۶۰٪ باشن
      const TOP_LIMIT = 3;
      const MIN_TOP_SCORE = 60;
      const topIndexes = [];
      matches.forEach((m, idx) => {
        if ((m.match_percent || 0) >= MIN_TOP_SCORE && topIndexes.length < TOP_LIMIT) {
          topIndexes.push(idx);
        }
      });

      matches.forEach((m, index) => {
        const p = m.profile || {};
        const card = document.createElement("div");

        const isTopPick = topIndexes.includes(index);
        card.className = "match-card" + (isTopPick ? " top-pick" : "");

        const header = document.createElement("div");
        header.className = "match-name-row";

        const name = document.createElement("div");
        name.className = "match-name";
        name.textContent = m.username;

        header.appendChild(name);

        // اگر Top pick است، badge اضافه کن
        if (isTopPick) {
          const topBadge = document.createElement("span");
          topBadge.className = "top-pick-badge";
          topBadge.textContent = "Top pick";
          header.appendChild(topBadge);
        } else {
          const meta = document.createElement("div");
          meta.className = "badge-small";
          meta.textContent = p.platform ? p.platform : "Any platform";
          header.appendChild(meta);
        }

        const badges = document.createElement("div");
        badges.className = "match-badges";

        if (p.region) {
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = `Region: ${p.region}`;
          badges.appendChild(b);
        }
        if (p.favorite_mode) {
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = `Mode: ${p.favorite_mode}`;
          badges.appendChild(b);
        }
        if (p.class_type) {
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = `Class: ${p.class_type}`;
          badges.appendChild(b);
        }
        if (p.mic) {
          const b = document.createElement("span");
          b.className = "badge badge-soft";
          b.textContent = `Mic: ${p.mic}`;
          badges.appendChild(b);
        }
        if (p.languages) {
          const b = document.createElement("span");
          b.className = "badge badge-soft";
          b.textContent = `Lang: ${p.languages}`;
          badges.appendChild(b);
        }

        const score = document.createElement("div");
        score.className = "match-score " + scoreClass(m.match_percent || 0);
        score.textContent = `${m.match_percent ?? 0}%`;

        const headerRow = document.createElement("div");
        headerRow.style.display = "flex";
        headerRow.style.justifyContent = "space-between";
        headerRow.style.alignItems = "center";
        headerRow.appendChild(header);
        headerRow.appendChild(score);

        const reasonsBox = document.createElement("div");
        reasonsBox.className = "reasons";

        const title = document.createElement("div");
        title.className = "reasons-title";
        title.textContent = "Why this match:";

        const ul = document.createElement("ul");
        (m.reasons || []).forEach((r) => {
          const li = document.createElement("li");
          li.textContent = r;
          ul.appendChild(li);
        });

        reasonsBox.appendChild(title);
        reasonsBox.appendChild(ul);

        const actions = document.createElement("div");
        actions.className = "match-actions";

        const likeBtn = document.createElement("button");
        likeBtn.className = "like-btn";
        likeBtn.dataset.username = m.username;

        const isLiked = likedUsers.has(m.username);
        if (isLiked) {
          likeBtn.textContent = "Added ✓";
          likeBtn.disabled = true;
        } else {
          likeBtn.textContent = "Add to squad";
          likeBtn.disabled = false;
        }

        actions.appendChild(likeBtn);

        card.appendChild(headerRow);
        card.appendChild(badges);
        card.appendChild(reasonsBox);
        card.appendChild(actions);

        matchesList.appendChild(card);
      });
    }


        function initSwipe(matches) {
      const raw = matches || [];

      // ۱) فقط کسایی که already liked نیستن
      let filtered = raw.filter((m) => !likedUsers.has(m.username));

      // ۲) فقط مچ‌های قوی‌تر (مثلاً ۵۰٪ به بالا)
      filtered = filtered.filter((m) => (m.match_percent || 0) >= 50);

      swipeMatches = filtered;
      swipeIndex = 0;

      // اگر هیچ مچ قوی‌ای نبود، وضعیت رو تو swipeStatus توضیح بده
      if (!swipeMatches.length) {
        swipeStatus.textContent = "No strong matches to swipe. Try changing region/mode.";
        swipeCard.innerHTML = "";
        swipeSkipBtn.disabled = true;
        swipeLikeBtn.disabled = true;
        return;
      }

      // در غیر این صورت کارت اول رو رندر کن
      renderSwipeCard();
    }


    function renderSwipeCard() {
      swipeCard.innerHTML = "";

      // 1) اصلاً مچی برای swipe نداریم
      if (!swipeMatches.length) {
        swipeStatus.textContent = "No matches to swipe. Run a search first.";
        swipeSkipBtn.disabled = true;
        swipeLikeBtn.disabled = true;
        // کارت خالی بماند (هیچ div داخل swipeCard نگذار)
        return;
      }

      // 2) به انتهای deck رسیدیم
      if (swipeIndex >= swipeMatches.length) {
        swipeStatus.textContent = "You reached the end of your current swipe deck.";
        swipeSkipBtn.disabled = true;
        swipeLikeBtn.disabled = true;
        // باز هم کارت خالی، فقط متن بالا
        return;
      }

      // 3) حالت عادی: کارت داریم
      swipeSkipBtn.disabled = false;
      swipeLikeBtn.disabled = false;

      const m = swipeMatches[swipeIndex];
      const p = m.profile || {};

      swipeStatus.textContent = `Card ${swipeIndex + 1} of ${swipeMatches.length}`;

      const box = document.createElement("div");
      box.className = "swipe-card-box";

      const mainRow = document.createElement("div");
      mainRow.className = "swipe-main-row";

      const left = document.createElement("div");
      const name = document.createElement("div");
      name.className = "swipe-name";
      name.textContent = m.username;

      const small = document.createElement("div");
      small.className = "swipe-small";
      small.textContent = `Match score: ${m.match_percent ?? 0}%`;

      left.appendChild(name);
      left.appendChild(small);

      const right = document.createElement("div");
      right.className = "match-score " + scoreClass(m.match_percent || 0);
      right.textContent = `${m.match_percent ?? 0}%`;

      mainRow.appendChild(left);
      mainRow.appendChild(right);

      const tags = document.createElement("div");
      tags.className = "swipe-tags";

      const tagItems = [
        p.region ? `Region: ${p.region}` : null,
        p.favorite_mode ? `Mode: ${p.favorite_mode}` : null,
        p.class_type ? `Class: ${p.class_type}` : null,
        p.mic ? `Mic: ${p.mic}` : null,
        p.languages ? `Lang: ${p.languages}` : null,
      ].filter(Boolean);

      tagItems.forEach((t) => {
        const span = document.createElement("span");
        span.className = "badge badge-soft";
        span.textContent = t;
        tags.appendChild(span);
      });

      const why = document.createElement("div");
      why.className = "swipe-small";
      if (m.reasons && m.reasons.length) {
        why.textContent = "Why this match: " + m.reasons.join(" • ");
      }

      box.appendChild(mainRow);
      box.appendChild(tags);
      box.appendChild(why);

      swipeCard.appendChild(box);
    }



    // کلیک روی Skip در swipe mode
    swipeSkipBtn.addEventListener("click", () => {
      if (!swipeMatches.length) return;
      swipeIndex += 1;
      renderSwipeCard();
    });

    // کلیک روی Add to squad در swipe mode
    swipeLikeBtn.addEventListener("click", async () => {
      if (!swipeMatches.length) return;
      if (swipeIndex >= swipeMatches.length) return;

      const current = swipeMatches[swipeIndex];
      const toUser = current.username;
      const fromUser = document.getElementById("username").value.trim();

      if (!fromUser) {
        alert("اول PlayMate username خودت را در فرم بالا بنویس.");
        return;
      }

      swipeLikeBtn.disabled = true;

      try {
        const res = await fetch("/api/like", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            from_user: fromUser,
            to_user: toUser,
            game: "battlefield",
          }),
        });

        if (!res.ok) {
          alert("Error " + res.status);
          swipeLikeBtn.disabled = false;
          return;
        }

        likedUsers.add(toUser);

        // بعد از لایک، رفرش Squad و برو کارت بعدی
        loadSquad(fromUser);

        swipeIndex += 1;
        renderSwipeCard();
      } catch (err) {
        console.error(err);
        alert("Network error");
        swipeLikeBtn.disabled = false;
      }
    });

    profileResetBtn.addEventListener("click", () => {
      // پاک کردن localStorage
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {
        console.error("Error clearing storage:", e);
      }

      // خالی کردن فرم
document.getElementById("username").value = "";
document.getElementById("region").value = "";
document.getElementById("city").value = "";
document.getElementById("platform").value = "";
document.getElementById("in_game_username").value = "";
document.getElementById("favorite_mode").value = "";
document.getElementById("class_type").value = "";
document.getElementById("mic").value = "";
document.getElementById("languages").value = "";
document.getElementById("username").value = "";
document.getElementById("in_game_username").value = "";
document.getElementById("platform").value = "";

regionEl.value = "";
populateCitiesForRegion("");   // city را disable + خالی می‌کند
cityEl.value = "";

favoriteModeEl.value = "";
document.getElementById("class_type").value = "";
document.getElementById("mic").value = "";

// languages: همه unchecked + hidden پاک
setLanguagesChecked("");


      // پاک کردن state ها
      likedUsers = new Set();
      swipeMatches = [];
      swipeIndex = 0;

      // پاک کردن UIهای وابسته
      matchesList.innerHTML = "";
      matchesCount.textContent = "No matches yet";
      setMatchesStatus('Fill your profile and click <b>Find matches</b> to see your squadmates.');

      squadList.innerHTML = "";
      setSquadStatus("Mutual likes will appear here once you and other players add each other.");

      swipeCard.innerHTML = "";
      swipeStatus.textContent = "Run a match search, then swipe through your top picks.";
      swipeSkipBtn.disabled = true;
      swipeLikeBtn.disabled = true;

      setProfileStatus("New profile – fill in your details and click “Find matches”.");
    });



    // ---------- رندر My Squad ----------
    function renderSquad(squadmates) {
      squadList.innerHTML = "";

      if (!squadmates || squadmates.length === 0) {
        setSquadStatus("No mutual squadmates yet.");
        return;
      }

      setSquadStatus(`You have ${squadmates.length} squadmate(s).`);


      squadmates.forEach((row) => {
        const name = row.squadmate || row.squadMate || row.squadMateName || row.username || "Unknown";

        const card = document.createElement("div");
        card.className = "squad-card";

        const main = document.createElement("div");
        main.className = "squad-main";

        const title = document.createElement("div");
        title.className = "squad-name";
        title.textContent = name;

        const tag = document.createElement("div");
        tag.className = "squad-tag";
        tag.textContent = "Mutual like – you both added each other";

        main.appendChild(title);
        main.appendChild(tag);

        const pill = document.createElement("div");
        pill.className = "squad-pill";
        pill.textContent = "Ready to squad up";

        card.appendChild(main);
        card.appendChild(pill);

        squadList.appendChild(card);
      });
    }

// ---------- لود کردن My Squad از سرور ----------
async function loadSquad(username) {
  if (!username) {
    setSquadStatus("Enter your PlayMate username above, then refresh.");
    squadList.innerHTML = "";
    return;
  }

  setSquadStatus("Loading squadmates...");
  squadList.innerHTML = "";

  try {
    const data = await fetchJson(
      "/api/my-squad?username=" + encodeURIComponent(username),
      {},
      12000
    );

    const rawList = (data && data.squadmates) ? data.squadmates : [];

    const uniqueList = [];
    const seen = new Set();
    for (const row of rawList) {
      const mate = row.squadmate;
      if (mate && !seen.has(mate)) {
        seen.add(mate);
        uniqueList.push(row);
      }
    }

    renderSquad(uniqueList);
  } catch (err) {
    console.error(err);
    const info = classifyError(err);

    if (info.kind === "timeout") {
      setSquadStatus("Squad request timed out. Please try again.");
    } else if (info.kind === "network") {
      setSquadStatus("Network error while loading squad. Please check your connection.");
    } else if (err && err.httpStatus) {
      setSquadStatus("Server error while loading squad (HTTP " + err.httpStatus + ").");
    } else {
      setSquadStatus("Error while loading squad: " + info.message);
    }
  }
}


  // ---------- submit فرم: save profile + match + auto squad refresh ----------
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  // جلوگیری از submit چندباره
  if (isSubmitting) return;
  lockSubmitUI();

  try {
    const payload = {
  username: document.getElementById("username").value.trim(),
  game: "battlefield",

  in_game_username: document.getElementById("in_game_username").value.trim() || null,

  platform: document.getElementById("platform").value.trim() || null,

  // regionId از dropdown
  region: regionEl.value.trim(),

  // city از dropdown (اجباری)
  city: cityEl.value.trim(),

  favorite_mode: favoriteModeEl.value,
  class_type: document.getElementById("class_type").value,
  mic: document.getElementById("mic").value,

  // از hidden input که با multi-select sync می‌شود
  languages: languagesHiddenEl.value.trim(),

  profile_pic_url: null,
  wallpaper_url: null,
  game_meta: {},
};


  // فعلاً خالی، بعداً در Profile page اضافه می‌کنیم
  profile_pic_url: null,
  wallpaper_url: null,
  game_meta: {},
};


    // ذخیره پروفایل در localStorage برای دفعات بعد
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      setProfileStatus(`Profile saved for "${payload.username}".`);
    } catch (e) {
      console.error("Error saving profile to storage:", e);
    }

    if (
  !payload.username ||
  !payload.region ||
  !payload.city ||
  !payload.favorite_mode ||
  !payload.class_type ||
  !payload.mic ||
  !payload.languages
) {
  alert("Please fill in all required fields before continuing.");
  return;
}


    // ---- منطق اصلی (همان قبلی شما) ----
    setMatchesStatus("Saving your profile & searching...");
    matchesList.innerHTML = "";
    matchesCount.textContent = "";

    // 1) ذخیره پروفایل (Fail-safe: خطا را نشان بده ولی ادامه بده)
    let profileSaved = true;
    try {
      await fetchJson(
        "/api/profile",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        },
        12000
      );
    } catch (err) {
      profileSaved = false;
      const info = classifyError(err);

      if (info.kind === "timeout") {
        setMatchesStatus("Profile save timed out. Continuing to match...");
      } else if (info.kind === "network") {
        setMatchesStatus("Network issue while saving profile. Continuing to match...");
      } else if (err && err.httpStatus) {
        setMatchesStatus(
          `Server error while saving profile (HTTP ${err.httpStatus}). Continuing to match...`
        );
      } else {
        setMatchesStatus("Profile save failed. Continuing to match...");
      }
      console.error("Profile save error:", err);
    }

    // 2) لود کردن لایک‌های قبلی (اگر شکست خورد، باز هم match را اجرا کن)
    try {
      await loadLikes(payload.username);
    } catch (err) {
      console.error("loadLikes failed (continuing):", err);
    }

    // 3) گرفتن مچ‌ها (این باید دقیق و fail-fast باشد)
    let data;
    try {
      data = await fetchJson(
        "/api/match",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        },
        15000
      );
    } catch (err) {
      const info = classifyError(err);

      if (info.kind === "timeout") {
        setMatchesStatus("Match search timed out. Please try again.");
      } else if (info.kind === "network") {
        setMatchesStatus(
          "Network error while searching matches. Check your connection and retry."
        );
      } else if (err && err.httpStatus) {
        setMatchesStatus(`Server error while searching matches (HTTP ${err.httpStatus}).`);
      } else {
        setMatchesStatus("Unexpected error while searching matches.");
      }

      console.error("Match error:", err);
      renderMatches([]);
      initSwipe([]);
      return; // finally اجرا می‌شود و دکمه آزاد می‌شود
    }

    const matches = data.matches || [];
    if (!matches.length) {
      setMatchesStatus("No matches found.");
      renderMatches([]);
      initSwipe([]);
    } else {
      if (!profileSaved) {
        setMatchesStatus("Matches found (profile not saved). You can retry later.");
      } else {
        setMatchesStatus("Done. These are your best current matches.");
      }
      renderMatches(matches);
      initSwipe(matches);
    }

    // 4) بعد از match، squad را هم رفرش کن
    loadSquad(payload.username);

  } catch (err) {
    console.error(err);
    setMatchesStatus(
      "Unexpected client error: " + (err && err.message ? err.message : String(err))
    );
  } finally {
    unlockSubmitUI();
  }
});


    // ---------- کلیک روی Add to squad ----------
    // ---------- کلیک روی Add to squad ----------
matchesList.addEventListener("click", async (e) => {
  const btn = e.target.closest(".like-btn");
  if (!btn) return;

  const toUser = btn.dataset.username;
  const fromUser = document.getElementById("username").value.trim();

  if (!fromUser) {
    alert("اول PlayMate username خودت را در فرم بالا بنویس.");
    return;
  }

  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "Added ✓";

  try {
  const data = await fetchJson("/api/like", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      from_user: fromUser,
      to_user: toUser,
      game: "battlefield",
    }),
  }, 12000);

  if (data && (data.status === "inserted" || data.status === "already_exists")) {
    likedUsers.add(toUser);
    loadSquad(fromUser);
    return;
  }

  // پاسخ غیرمنتظره
  btn.disabled = false;
  btn.textContent = oldText;
  alert("Unexpected response from server.");

} catch (err) {
  console.error(err);
  const info = classifyError(err);

  // دکمه را برگردان
  btn.disabled = false;
  btn.textContent = oldText;

  if (info.kind === "timeout") alert("Request timed out. Try again.");
  else if (info.kind === "network") alert("Network error. Check connection and retry.");
  else if (err && err.httpStatus) alert("Server error (HTTP " + err.httpStatus + ").");
  else alert("Unexpected error.");
}


});


    // ---------- کلیک روی دکمه Refresh My Squad ----------
    refreshSquadBtn.addEventListener("click", () => {
      const username = document.getElementById("username").value.trim();
      loadSquad(username);
    });

    // هنگام لود اولیه صفحه، swipe را با لیست خالی تنظیم کن
    initSwipe([]);


  });
</script>
</body>
</html>
