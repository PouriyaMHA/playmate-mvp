<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlayMate BF | Find Matches</title>
  <style>
    :root {
      --bg-dark: #050a10;
      --bg-panel: rgba(20, 30, 45, 0.6);
      --bg-card: rgba(30, 45, 60, 0.7);
      --neon-green: #00ffcc;
      --neon-blue: #00aaff;
      --neon-red: #ff3366;
      --text-main: #ffffff;
      --text-muted: #8ba2b5;
      --border-glass: 1px solid rgba(255, 255, 255, 0.1);
      --glow: 0 0 15px rgba(0, 255, 204, 0.2);
      --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      outline: none;
    }

    body {
      background-color: var(--bg-dark);
      background-image:
        radial-gradient(circle at 10% 20%, rgba(0, 255, 204, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(0, 170, 255, 0.05) 0%, transparent 20%);
      color: var(--text-main);
      font-family: var(--font-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* --- Layout --- */
    .app-container {
      display: grid;
      grid-template-columns: 320px 1fr 300px;
      gap: 20px;
      padding: 20px;
      height: 100%;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }

    .panel {
      background: var(--bg-panel);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: var(--border-glass);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    /* --- Typography & Commons --- */
    h2 {
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 20px;
      color: var(--neon-green);
      text-shadow: 0 0 5px rgba(0, 255, 204, 0.4);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding-bottom: 10px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 5px;
      margin-top: 15px;
    }

    input,
    select {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input:focus,
    select:focus {
      border-color: var(--neon-green);
      box-shadow: 0 0 8px rgba(0, 255, 204, 0.2);
    }

    /* --- Left Panel: Profile --- */
    .profile-status {
      font-size: 0.8rem;
      color: var(--neon-blue);
      margin-bottom: 15px;
      min-height: 1.2em;
    }

    .lang-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }

    .lang-pill {
      font-size: 0.75rem;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .lang-pill.active {
      background: rgba(0, 255, 204, 0.2);
      border-color: var(--neon-green);
      color: var(--neon-green);
    }

    .btn-primary {
      background: linear-gradient(135deg, rgba(0, 255, 204, 0.2), rgba(0, 170, 255, 0.2));
      border: 1px solid var(--neon-green);
      color: var(--neon-green);
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 25px;
      width: 100%;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background: var(--neon-green);
      color: #000;
      box-shadow: 0 0 15px var(--neon-green);
    }

    .profile-link {
      display: block;
      text-align: center;
      margin-top: 15px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.85rem;
    }

    .profile-link:hover {
      color: var(--neon-blue);
    }

    /* --- Center Panel: Match Card --- */
    .match-area {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
    }

    .card-container {
      width: 100%;
      max-width: 450px;
      height: 600px;
      position: relative;
      perspective: 1000px;
    }

    .match-card {
      background: linear-gradient(160deg, #1a253a, #0d121c);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      position: absolute;
      top: 0;
      left: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
      backface-visibility: hidden;
    }

    .match-card.swipe-left {
      transform: translateX(-150%) rotate(-20deg);
      opacity: 0;
    }

    .match-card.swipe-right {
      transform: translateX(150%) rotate(20deg);
      opacity: 0;
    }

    .avatar-lg {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(45deg, #333, #555);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: bold;
      color: white;
      border: 3px solid var(--neon-blue);
      box-shadow: 0 0 20px rgba(0, 170, 255, 0.3);
      margin-bottom: 20px;
    }

    .match-percent {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 255, 204, 0.1);
      color: var(--neon-green);
      border: 1px solid var(--neon-green);
      padding: 5px 10px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .player-name {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .pill-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .info-pill {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8rem;
      color: #ddd;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .match-reasons {
      width: 100%;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: auto;
    }

    .match-reasons h4 {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .match-reasons ul {
      list-style: none;
    }

    .match-reasons li {
      font-size: 0.9rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
    }

    .match-reasons li::before {
      content: 'â€¢';
      color: var(--neon-green);
      margin-right: 8px;
      font-size: 1.2rem;
    }

    .actions {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      width: 100%;
    }

    .action-btn {
      flex: 1;
      padding: 15px;
      border-radius: 50px;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-skip {
      background: rgba(255, 51, 102, 0.1);
      border: 2px solid var(--neon-red);
      color: var(--neon-red);
    }

    .btn-skip:hover {
      background: var(--neon-red);
      color: white;
      transform: scale(1.05);
    }

    .btn-like {
      background: rgba(0, 255, 204, 0.1);
      border: 2px solid var(--neon-green);
      color: var(--neon-green);
    }

    .btn-like:hover {
      background: var(--neon-green);
      color: black;
      transform: scale(1.05);
    }

    /* --- Right Panel: Squad --- */
    .squad-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .squad-member {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.03);
      padding: 10px;
      border-radius: 8px;
      border-left: 3px solid transparent;
      transition: background 0.2s;
    }

    .squad-member:hover {
      background: rgba(255, 255, 255, 0.08);
      border-left-color: var(--neon-blue);
    }

    .sm-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #444;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 12px;
      font-size: 0.9rem;
    }

    .sm-info {
      flex: 1;
    }

    .sm-name {
      font-weight: bold;
      font-size: 0.95rem;
      display: block;
    }

    .sm-ign {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: block;
    }

    .status-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .status-online {
      color: var(--neon-green);
      background: rgba(0, 255, 204, 0.1);
    }

    .status-offline {
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.05);
    }

    /* --- Modal --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .match-modal {
      background: linear-gradient(135deg, #0d121c, #1a253a);
      padding: 40px;
      border-radius: 20px;
      border: 2px solid var(--neon-green);
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 50px rgba(0, 255, 204, 0.3);
      transform: scale(0.8);
      transition: transform 0.3s;
    }

    .modal-overlay.active .match-modal {
      transform: scale(1);
    }



    /* âœ… Ø®ÙˆØ¯ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² fireworks */
    .match-modal-fancy {
      position: relative;
      background: radial-gradient(circle at top, #0f172a, #0b1220);
      border: 2px solid rgba(0, 255, 204, 0.7);
      box-shadow: 0 0 60px rgba(0, 255, 204, 0.25);
      overflow: hidden;
      /* ØªØ§ Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ Ø¨ÛŒØ±ÙˆÙ† Ù†Ø²Ù†Ù† */
      position: relative;
      z-index: 2;
    }

    /* --- Fireworks: thin rays + sparkles (no green rectangle) --- */
    #match-modal::before {
      content: "";
      position: absolute;
      left: 50%;
      top: calc(50% - 360px);
      /* Ø¨Ø§Ù„Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ */
      width: 760px;
      height: 260px;
      transform: translateX(-50%);
      pointer-events: none;
      z-index: 1;
      opacity: .95;
      mix-blend-mode: screen;

      /* 1) rays: repeating-conic = ØªÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø±ÛŒÚ© Ùˆ Ø²ÛŒØ§Ø¯ */
      background:
        repeating-conic-gradient(from 200deg at 50% 92%,
          rgba(52, 245, 197, .75) 0 1deg,
          transparent 1deg 7deg),
        repeating-conic-gradient(from 220deg at 50% 92%,
          rgba(34, 211, 238, .55) 0 .8deg,
          transparent .8deg 9deg);

      /* 2) fade Ù…Ø§Ø³Ú©: ÙÙ‚Ø· Ø¨Ø§Ù„Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø¯ÛŒØ¯Ù‡ Ø¨Ø´Ù‡ (Ù…Ø³ØªØ·ÛŒÙ„ Ù†Ø´Ù‡) */
      -webkit-mask-image: radial-gradient(circle at 50% 92%, #000 0 42%, transparent 70%);
      mask-image: radial-gradient(circle at 50% 92%, #000 0 42%, transparent 70%);

      filter: blur(.25px) drop-shadow(0 0 16px rgba(52, 245, 197, .35));
      animation: fireworksPulse 1.8s ease-in-out infinite;
    }

    #match-modal::after {
      content: "";
      position: absolute;
      left: 50%;
      top: calc(50% - 360px);
      /* Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…â€ŒÙ…Ø­Ù„ ::before */
      width: 760px;
      height: 260px;
      transform: translateX(-50%);
      pointer-events: none;
      z-index: 1;
      opacity: .85;
      mix-blend-mode: screen;

      /* sparkles: Ø¬Ø±Ù‚Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú© */
      background:
        radial-gradient(circle at 18% 35%, rgba(255, 255, 255, .35), transparent 28%),
        radial-gradient(circle at 30% 22%, rgba(52, 245, 197, .45), transparent 30%),
        radial-gradient(circle at 45% 30%, rgba(34, 211, 238, .32), transparent 30%),
        radial-gradient(circle at 60% 20%, rgba(52, 245, 197, .35), transparent 32%),
        radial-gradient(circle at 78% 34%, rgba(255, 255, 255, .25), transparent 30%),
        radial-gradient(circle at 52% 42%, rgba(34, 211, 238, .20), transparent 34%);

      -webkit-mask-image: radial-gradient(circle at 50% 92%, #000 0 40%, transparent 72%);
      mask-image: radial-gradient(circle at 50% 92%, #000 0 40%, transparent 72%);

      filter: blur(.35px) drop-shadow(0 0 10px rgba(52, 245, 197, .25));
      animation: sparkleDrift 2.2s ease-in-out infinite;
    }

    @keyframes fireworksPulse {
      0% {
        transform: translateX(-50%) scale(.98);
        opacity: .55;
      }

      50% {
        transform: translateX(-50%) scale(1.03);
        opacity: .98;
      }

      100% {
        transform: translateX(-50%) scale(.98);
        opacity: .65;
      }
    }

    @keyframes sparkleDrift {
      0% {
        transform: translateX(-50%) translateY(0) scale(.98);
        opacity: .55;
      }

      50% {
        transform: translateX(-50%) translateY(-8px) scale(1.02);
        opacity: .95;
      }

      100% {
        transform: translateX(-50%) translateY(0) scale(.98);
        opacity: .65;
      }
    }





    .match-title {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--neon-green);
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    .match-avatars {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .modal-btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      border: none;
    }

    .btn-view-squad {
      background: var(--neon-green);
      color: #000;
    }

    .btn-keep-matching {
      background: transparent;
      border: 1px solid var(--text-muted);
      color: var(--text-muted);
    }

    .btn-keep-matching:hover {
      color: white;
      border-color: white;
    }

    /* --- Toast --- */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 2000;
    }

    .match-close {
      position: absolute;
      top: 10px;
      right: 12px;
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.25);
      color: rgba(255, 255, 255, 0.85);
      cursor: pointer;
      font-size: 18px;
      line-height: 30px;
    }

    .match-sub {
      margin-top: -6px;
      margin-bottom: 22px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .match-highlight {
      color: var(--neon-green);
      font-weight: 700;
    }

    .match-avatars.fancy {
      display: grid;
      grid-template-columns: 1fr 1fr;
      /* ÙÙ‚Ø· Ø¯Ùˆ Ø³ØªÙˆÙ† */
      align-items: center;
      column-gap: 18px;
      margin: 18px 0 22px;
      position: relative;
      /* âœ… Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù‚ absolute */
    }

    .avatar-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-width: 0;
      /* Ø¨Ø±Ø§ÛŒ ellipsis */
      position: relative;
      z-index: 2;
      /* Ø±ÙˆÛŒ Ø¨Ø±Ù‚ Ø¨ÛŒØ§Ø¯ */
    }

    .avatar-name {
      margin-top: 10px;
      line-height: 1.1;
      width: 100%;
      max-width: 190px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .avatar-ign {
      margin-top: 6px;
      width: 100%;
      max-width: 190px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* âœ… Ø¨Ø±Ù‚ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ ÙˆØ³Ø· Ø¯Ùˆ Ø¢ÙˆØ§ØªØ§Ø± Ùˆ ÙˆØµÙ„â€ŒÚ©Ù†Ù†Ø¯Ù‡ */
    .match-link {
      position: absolute;
      left: 50%;
      top: 46px;
      /* âœ… Ù…Ø±Ú©Ø² Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§Ø› Ø§Ú¯Ø± avatar Ø¨Ø²Ø±Ú¯/Ú©ÙˆÚ†Ú© Ø´Ø¯ Ø§ÛŒÙ† Ø¹Ø¯Ø¯ Ø±Ø§ ÙÙ‚Ø· ØªÙ†Ø¸ÛŒÙ… Ú©Ù† */
      transform: translateX(-50%);
      width: 300px;
      /* Ø·ÙˆÙ„ Ø§ØªØµØ§Ù„ (Ø¨Ù‡ Ø¢ÙˆØ§ØªØ§Ø±Ù‡Ø§ Ø¨Ø±Ø³Ø¯) */
      height: 46px;
      pointer-events: none;
      z-index: 1;
    }

    /* SVG Ø¨Ø±Ù‚ */
    .match-link .electric {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    /* Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ */
    .match-link .electric .e {
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;

      /* Ø¨Ø±Ù‚ Ø¨Ø§ÛŒØ¯ Ù¾ÛŒÙˆØ³ØªÙ‡ Ø¨Ø§Ø´Ø¯ */
      stroke-width: 2.8;
      opacity: .92;

      /* Ù…Ù‡Ù…: Ø¨Ù‡â€ŒØ¬Ø§ÛŒ dashØŒ Ø¬Ø±ÛŒØ§Ù† ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ ÙÛŒÙ„ØªØ± */
      filter: url(#electricFlow);

      /* ÙÙ„ÛŒÚ©Ø± Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ú© */
      animation: elecFlicker 220ms steps(2, end) infinite;
    }

    /* Ø±Ù†Ú¯/Ø¶Ø®Ø§Ù…Øªâ€ŒÙ‡Ø§ (Ù‡Ù…ÙˆÙ†â€ŒÙ‡Ø§ Ø±Ùˆ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… ÙˆÙ„ÛŒ Ú©Ù…ÛŒ Ø·Ø¨ÛŒØ¹ÛŒâ€ŒØªØ±) */
    .match-link .electric .e1 {
      stroke: rgba(52, 245, 197, .95);
      stroke-width: 3.4;
    }

    .match-link .electric .e2 {
      stroke: rgba(34, 211, 238, .78);
      stroke-width: 2.5;
      opacity: .75;
    }

    .match-link .electric .e3 {
      stroke: rgba(255, 255, 255, .55);
      stroke-width: 1.9;
      opacity: .55;
    }

    .match-link .electric .e4 {
      stroke: rgba(52, 245, 197, .70);
      stroke-width: 2.3;
      opacity: .68;
    }

    @keyframes elecFlicker {
      0% {
        opacity: .55;
      }

      40% {
        opacity: .95;
      }

      100% {
        opacity: .70;
      }
    }


    /* Ø¬Ø±Ù‚Ù‡ Ø³Ø±Ù‡Ø§ */
    .match-link .spark {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      opacity: .95;
      pointer-events: none;
      background:
        radial-gradient(circle at 50% 50%, rgba(255, 255, 255, .85), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(52, 245, 197, .35), transparent 62%),
        conic-gradient(from 0deg, rgba(34, 211, 238, 0), rgba(52, 245, 197, .95), rgba(255, 255, 255, .55), rgba(34, 211, 238, 0));
      filter: blur(.2px) drop-shadow(0 0 18px rgba(52, 245, 197, .85));
      animation: sparkPulse 1.0s ease-in-out infinite;
    }

    .match-link .spark-left {
      left: -16px;
    }

    .match-link .spark-right {
      right: -16px;
    }

    @keyframes sparkPulse {
      0% {
        transform: translateY(-50%) scale(.85);
        opacity: .25;
      }

      45% {
        transform: translateY(-50%) scale(1.08);
        opacity: 1;
      }

      100% {
        transform: translateY(-50%) scale(.9);
        opacity: .35;
      }
    }


    .avatar-lg.me,
    .avatar-lg.them {
      position: relative;
    }

    .avatar-lg.me {
      box-shadow: 0 0 24px rgba(34, 211, 238, .22);
    }

    .avatar-lg.them {
      box-shadow: 0 0 24px rgba(52, 245, 197, .22);
    }

    .avatar-lg.me::after,
    .avatar-lg.them::after {
      content: "";
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 2px solid rgba(52, 245, 197, .18);
      opacity: .0;
      animation: pulseRing 2.2s ease-in-out infinite;
    }

    .avatar-lg.me::after {
      border-color: rgba(34, 211, 238, .18);
    }

    @keyframes pulseRing {
      0% {
        transform: scale(.92);
        opacity: 0;
      }

      35% {
        opacity: .65;
      }

      100% {
        transform: scale(1.08);
        opacity: 0;
      }
    }


    .btn-view-squad {
      box-shadow: 0 0 28px rgba(52, 245, 197, .22);
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .btn-view-squad:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 40px rgba(52, 245, 197, .32);
    }

    .btn-keep-matching {
      opacity: .9;
      transition: opacity .15s ease;
    }

    .btn-keep-matching:hover {
      opacity: 1;
    }


    .avatar-name,
    .match-highlight {
      max-width: 160px;
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: bottom;
    }

    .btn-keep-matching {
      background: rgba(255, 255, 255, 0.03);
      border-color: rgba(255, 255, 255, 0.18);
    }


    .match-actions {
      margin-top: 10px;
    }


    .toast {
      background: #222;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      border-left: 4px solid #555;
      animation: slideUp 0.3s ease;
    }

    .toast.success {
      border-left-color: var(--neon-green);
    }

    .toast.error {
      border-left-color: var(--neon-red);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .app-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        overflow-y: auto;
      }

      .panel {
        max-height: 80vh;
      }

      .card-container {
        height: 500px;
      }
    }
  </style>
</head>

<body>

  <div id="net-banner" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  right:0;
  z-index:9999;
  background:#7c2d12;
  color:#fff;
  padding:8px 14px;
  font-size:0.85rem;
  align-items:center;
  justify-content:space-between;
">
    <span>âš  Connection issue. Some features may not work.</span>
    <button id="net-retry" style="
    background:#fff;
    color:#7c2d12;
    border:none;
    padding:4px 10px;
    border-radius:6px;
    cursor:pointer;
    font-size:0.8rem;
  ">
      Retry
    </button>
  </div>


  <div class="app-container">

    <div class="panel">
      <h2>My Profile</h2>
      <div id="profile-status" class="profile-status">New profile â€“ fill in your details</div>

      <form id="profile-form">
        <label>PlayMate Username</label>
        <input type="text" id="username" placeholder="e.g. NeonSlayer" required>

        <label>Region</label>
        <select id="region" class="glass-input" required>
          <option value="">Select Region...</option>
        </select>


        <label>City / Sub-region</label>
        <select id="city" class="glass-input" style="margin-top: 8px;" disabled>
          <option value="">Select City...</option>
        </select>


        <label>Platform</label>
        <select id="platform">
          <option value="PC">PC</option>
          <option value="Xbox">Xbox</option>
          <option value="PlayStation">PlayStation</option>
        </select>


        <label>Battlefield Username (In-Game)</label>
        <input type="text" id="in_game_username" placeholder="Origin/EA ID" required>

        <label>Favorite Mode</label>
        <select id="favorite_mode" class="glass-input" style="margin-bottom:8px;">
          <option value="">Fav Mode...</option>
        </select>


        <label>Class / Role</label>
        <select id="class_type">
          <option value="Assault">Assault</option>
          <option value="Medic">Medic</option>
          <option value="Engineer">Engineer</option>
          <option value="Recon">Recon</option>
          <option value="Vehicle">Vehicle Main</option>
        </select>

        <label>Mic Preference</label>
        <select id="mic">
          <option value="voice">Voice</option>
          <option value="both">Voice + Text</option>
          <option value="none">No mic</option>
        </select>


        <label>Languages</label>
        <div class="lang-grid" id="lang-container"></div>

        <button type="submit" id="btn-find-matches" class="btn-primary">Find Matches</button>
      </form>

      <a href="#" class="profile-link" id="view-profile-link" style="display:none;">View public profile â†’</a>

    </div>

    <div class="panel match-area">
      <div id="card-wrapper" class="card-container">
        <div class="empty-state">
          <h3>Ready to Deploy?</h3>
          <p style="color: var(--text-muted); margin-top: 10px;">Update your profile and click "Find Matches" to scan
            for squadmates.</p>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>My Squad</h2>
      <div id="squad-list" class="squad-list">
        <div class="empty-state" style="font-size: 0.9rem;">No squadmates yet. Start matching!</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="match-modal">
    <div class="match-modal match-modal-fancy">
      <button class="match-close" onclick="closeModal()">Ã—</button>

      <div class="match-title">IT'S A MATCH!</div>
      <div class="match-sub">
        Squadmate unlocked:
        <span id="modal-them-name" class="match-highlight">User</span>

      </div>

      <div class="match-avatars fancy">
        <div class="avatar-block">
          <div class="avatar-lg me" id="modal-me-avatar">P</div>
          <div class="avatar-name" id="modal-me-name">You</div>
          <div class="avatar-ign" id="modal-me-ign">In-game: â€”</div>
        </div>

        <div class="match-link" aria-hidden="true">
          <svg class="electric" viewBox="0 0 320 60" preserveAspectRatio="none">
            <defs>
              <!-- Glow Ù†Ø±Ù… -->
              <filter id="glow" x="-40%" y="-40%" width="180%" height="180%">
                <feGaussianBlur stdDeviation="2.4" result="b" />
                <feMerge>
                  <feMergeNode in="b" />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>

              <!-- Electric flow: turbulence + displacement -->
              <filter id="electricFlow" x="-40%" y="-80%" width="180%" height="260%">
                <feTurbulence type="fractalNoise" baseFrequency="0.012 0.18" numOctaves="2" seed="2" result="noise">
                  <animate attributeName="baseFrequency" dur="600ms" values="0.010 0.16; 0.014 0.22; 0.010 0.16"
                    repeatCount="indefinite" />
                </feTurbulence>

                <feDisplacementMap in="SourceGraphic" in2="noise" scale="14" xChannelSelector="R" yChannelSelector="G"
                  result="warp" />

                <!-- Glow Ø¯Ø§Ø®Ù„ÛŒ -->
                <feGaussianBlur in="warp" stdDeviation="2.2" result="glowBlur" />
                <feColorMatrix in="glowBlur" type="matrix" values="
      1 0 0 0 0
      0 1 0 0 0
      0 0 1 0 0
      0 0 0 0.9 0" result="glow" />

                <feMerge>
                  <feMergeNode in="glow" />
                  <feMergeNode in="warp" />
                </feMerge>
              </filter>

            </defs>


            <!-- Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù‚ -->
            <path class="e e1" d="M0,30 C40,18 70,40 110,30 C150,20 180,44 220,30 C255,20 285,38 320,30" />
            <path class="e e2" d="M0,30 C35,10 75,48 115,30 C150,12 190,50 230,30 C265,12 290,46 320,30" />
            <path class="e e3" d="M0,30 C45,24 70,34 110,30 C150,26 180,36 220,30 C255,26 285,34 320,30" />
            <path class="e e4" d="M0,30 C55,8 85,52 125,30 C165,8 205,52 245,30 C275,12 300,44 320,30" />
          </svg>

          <span class="spark spark-left"></span>
          <span class="spark spark-right"></span>
        </div>



        <div class="avatar-block">
          <div class="avatar-lg them" id="modal-them-avatar">B</div>
          <div class="avatar-name" id="modal-them-name-2">User</div>
          <div class="avatar-ign" id="modal-them-ign">In-game: â€”</div>
        </div>
      </div>

      <div class="match-actions">
        <button class="modal-btn btn-view-squad" onclick="goToSquad()">View Squad</button>

        <button class="modal-btn btn-keep-matching" onclick="closeModal()">Continue Matching</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <script>
    /* =========================================================
       PlayMate BF â€” ui.html script (refactored for readability)
       Logic unchanged; formatting + organization only.
       ========================================================= */

    /* -----------------------
       GLOBALS / CONSTANTS
    ------------------------*/
    let lastSquadSignature = "";

    const API_BASE = "/api";     // Relative path
    const GAME = "battlefield";
    const REALTIME_INTERVAL_MS = 30000;

    let META = null;

    /* Realtime (single timer) */
    let realtimeTimer = null;

    /* In-flight guards (Step 9E) */
    const inFlight = {
      ping: false,
      squad: false,
      match: false,
      like: false,
      save: false
    };

    /* -----------------------
       STATE
    ------------------------*/
    const state = {
      profile: {
        username: "",
        display_username: "",
        region: "",
        city: "",
        platform: "PC",
        in_game_username: "",
        favorite_mode: "Conquest",
        class_type: "Assault",
        mic: "voice",
        languages: []
      },
      matches: [],
      currentMatchIndex: 0,
      squad: [],
      loading: false
    };

    /* -----------------------
       DOM ELEMENTS
    ------------------------*/
    const els = {
      form: document.getElementById("profile-form"),
      status: document.getElementById("profile-status"),
      langContainer: document.getElementById("lang-container"),
      cardWrapper: document.getElementById("card-wrapper"),
      squadList: document.getElementById("squad-list"),
      modal: document.getElementById("match-modal"),
      viewProfileLink: document.getElementById("view-profile-link"),

      region: document.getElementById("region"),
      city: document.getElementById("city"),
      favoriteMode: document.getElementById("favorite_mode"),
      platform: document.getElementById("platform"),
      classType: document.getElementById("class_type"),
      mic: document.getElementById("mic"),
      ign: document.getElementById("in_game_username"),
      username: document.getElementById("username"),

      btnFind: document.getElementById("btn-find-matches")
    };

    /* =========================================================
       INIT
    ========================================================= */
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await loadMeta();
        populateRegions();
        populateFavoriteModes();
        renderLanguagesFromMeta();
      } catch (e) {
        console.error(e);
        showToast("Failed to load game meta", "error");
      }

      // Now that select options + language pills exist, restore works
      loadProfileFromStorage();

      if ((state.profile.username || "").trim()) startRealtime();

      setupEventListeners();

      // Restore language pills after pills created from meta
      applyStoredLanguagesToPills();

      // If region from storage set, rebuild city list
      if (state.profile.region) {
        els.region.dispatchEvent(new Event("change"));
        if (state.profile.city) els.city.value = state.profile.city;
      }

      if (state.profile.username) refreshSquad();
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        stopRealtime();
      } else {
        if ((state.profile.username || "").trim()) startRealtime();
      }
    });

    window.addEventListener("beforeunload", () => stopRealtime());

    /* =========================================================
       HELPERS
    ========================================================= */
    const netBanner = document.getElementById("net-banner");
    const netRetryBtn = document.getElementById("net-retry");

    function showNetError() {
      if (netBanner) netBanner.style.display = "flex";
    }

    function hideNetError() {
      if (netBanner) netBanner.style.display = "none";
    }

    netRetryBtn?.addEventListener("click", () => {
      hideNetError();
      findMatches();
      refreshSquad();
    });

    function showToast(msg, type = "info") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      document.getElementById("toast-container").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function getInitials(name) {
      return name ? name.substring(0, 1).toUpperCase() : "?";
    }

    function computeSquadSignature(squad) {
      // include last_active (affects UI status)
      return (squad || [])
        .map(m => `${(m.username || "").toLowerCase()}|${m.in_game_username || ""}|${m.last_active || ""}`)
        .sort()
        .join(";");
    }

    function setLoading(isLoading, message = "Scanning for Operators...") {
      state.loading = !!isLoading;

      // Find Matches button
      if (els.btnFind) els.btnFind.disabled = !!isLoading;

      // Match card buttons
      const likeBtn = document.querySelector(".btn-like");
      const skipBtn = document.querySelector(".btn-skip");
      if (likeBtn) likeBtn.disabled = !!isLoading;
      if (skipBtn) skipBtn.disabled = !!isLoading;

      // Center message area
      if (els.cardWrapper && isLoading) {
        els.cardWrapper.innerHTML = `
      <div class="empty-state">
        <div style="opacity:.85; font-weight:600;">${message}</div>
        <div style="margin-top:10px; opacity:.6; font-size:.9rem;">Please waitâ€¦</div>
      </div>
    `;
      }
    }

    /* =========================================================
       REALTIME (SINGLE TIMER) â€” Step 9E
    ========================================================= */
    function canRealtimeRun() {
      const u = (state.profile.username || "").trim();
      if (!u) return false;
      if (document.visibilityState === "hidden") return false;
      return true;
    }

    async function realtimeTick({ silentSquad = true } = {}) {
      if (!canRealtimeRun()) return;

      // 1) Ping (guard)
      if (!inFlight.ping) {
        inFlight.ping = true;
        try {
          const u = (state.profile.username || "").trim();
          const res = await fetch(`${API_BASE}/ping?username=${encodeURIComponent(u)}&game=${GAME}`, { method: "POST" });

          // Ø§Ú¯Ø± ping ok Ø¨ÙˆØ¯ØŒ ÛŒØ¹Ù†ÛŒ connection Ø®ÙˆØ¨Ù‡
          if (res.ok) hideNetError();
          else showNetError();
        } catch {
          // network/backend down
          showNetError();
        } finally {
          inFlight.ping = false;
        }
      }

      // 2) Squad refresh (let refreshSquad manage inFlight.squad)
      try {
        await refreshSquad({ silent: !!silentSquad });

        // Ø§Ú¯Ø± refreshSquad Ø¨Ø¯ÙˆÙ† throw Ø¨Ø±Ú¯Ø±Ø¯Ù‡ØŒ ÛŒØ¹Ù†ÛŒ ok
        hideNetError();
      } catch {
        showNetError();
      }

    }


    function startRealtime() {
      // prevent duplicate intervals
      if (realtimeTimer) return;

      // immediate tick once
      realtimeTick({ silentSquad: true });

      // single interval
      realtimeTimer = setInterval(() => realtimeTick({ silentSquad: true }), REALTIME_INTERVAL_MS);
    }

    function stopRealtime() {
      if (realtimeTimer) {
        clearInterval(realtimeTimer);
        realtimeTimer = null;
      }

      // reset guards (safe)
      inFlight.ping = false;
      inFlight.squad = false;
    }

    // // Legacy wrapper: keep for backward compatibility
    // function setupHeartbeat() {
    //   startRealtime();
    // }


    /* =========================================================
       PROFILE
    ========================================================= */
    function setupEventListeners() {
      // Region -> City
      els.region.addEventListener("change", () => {
        els.city.innerHTML = `<option value="">Select City...</option>`;
        els.city.disabled = true;

        const regionData = (META?.regions || []).find(r => r.id === els.region.value);
        if (!regionData) return;

        els.city.disabled = false;
        (regionData.cities || []).forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          els.city.appendChild(opt);
        });
      });

      // Form submit -> Save + Match
      els.form.addEventListener("submit", async (e) => {
        e.preventDefault();
        await saveProfile();
        findMatches();
      });
    }

    function updateStateLangs() {
      updateStateLangsFromPills(); // alias
    }

    function loadProfileFromStorage() {
      const stored = localStorage.getItem("playmate_profile");
      if (!stored) return;

      try {
        const data = JSON.parse(stored);

        // state
        state.profile = { ...state.profile, ...data };

        // DOM
        els.username.value = data.display_username || data.username || "";
        els.ign.value = data.in_game_username || "";
        els.region.value = data.region || "";
        els.city.value = data.city || "";
        els.platform.value = data.platform || "PC";
        els.favoriteMode.value = data.favorite_mode || "Conquest";
        els.classType.value = data.class_type || "Assault";
        els.mic.value = data.mic || "voice";

        // langs (string "en,fa" or array)
        if (data.languages) {
          if (Array.isArray(data.languages)) state.profile.languages = data.languages;
          else state.profile.languages = String(data.languages).split(",").map(x => x.trim()).filter(Boolean);

          applyStoredLanguagesToPills();
        }

        els.status.textContent = `Profile loaded for '${data.display_username || data.username || ""}'`;
        updateProfileLink(data.username);
      } catch (e) {
        console.error("Error parsing profile", e);
      }
    }

    async function saveProfile() {
      // state <- DOM
      state.profile.display_username = els.username.value;
      state.profile.username = state.profile.display_username.toLowerCase();
      state.profile.in_game_username = els.ign.value;
      state.profile.region = els.region.value;
      state.profile.city = els.city.value;
      state.profile.platform = els.platform.value;
      state.profile.favorite_mode = els.favoriteMode.value;
      state.profile.class_type = els.classType.value;
      state.profile.mic = els.mic.value;
      updateStateLangs();

      // payload
      const payload = {
        username: state.profile.username,
        display_username: state.profile.display_username,
        game: GAME,
        region: state.profile.region,
        city: state.profile.city,
        platform: state.profile.platform,
        favorite_mode: state.profile.favorite_mode,
        class_type: state.profile.class_type,
        mic: state.profile.mic,
        languages: (state.profile.languages || []).join(","), // "en,fa"
        in_game_username: state.profile.in_game_username,
        profile_pic_url: null,
        wallpaper_url: null,
        game_meta: {}
      };

      try {
        const res = await fetch(`${API_BASE}/profile`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (res.status === 409) {
          showToast("This Battlefield username is already used by another PlayMate user.", "error");
          throw new Error("Conflict");
        }
        if (!res.ok) throw new Error("Save failed");

        // store local only after success
        localStorage.setItem("playmate_profile", JSON.stringify(payload));
        updateProfileLink(state.profile.username);

        els.status.textContent = "Profile saved successfully!";
        showToast("Profile saved!", "success");

        startRealtime();
      } catch (err) {
        console.error(err);
        if (err.message !== "Conflict") showToast("Failed to save profile", "error");
      }
    }

    function updateProfileLink(username) {
      const a = els.viewProfileLink;
      if (!a) return;

      const u = (username || "").trim().toLowerCase();
      if (!u) {
        a.href = "#";
        a.style.display = "none";
        a.onclick = null;
        return;
      }

      a.href = "/profile?username=" + encodeURIComponent(u);
      a.style.display = "block";
      a.onclick = null;
    }

    /* =========================================================
       MATCHING
    ========================================================= */
    async function findMatches() {
      if (state.loading) return;
      if (inFlight.match) return;

      inFlight.match = true;
      try {
        setLoading(true, "Scanning for Operators...");

        const res = await fetch(`${API_BASE}/match`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: state.profile.username,
            game: GAME,
            region: els.region.value,
            city: els.city.value,
            favorite_mode: els.favoriteMode.value,
            class_type: els.classType.value,
            mic: els.mic.value,
            languages: (state.profile.languages || []).join(","),
            platform: els.platform.value || null,
            in_game_username: (els.ign.value || "").trim() || null,
            profile_pic_url: null,
            wallpaper_url: null,
            game_meta: {}
          })
        });

        if (!res.ok) {
          let msg = `match failed: ${res.status}`;
          try {
            const j = await res.json();
            if (j?.detail) msg = (typeof j.detail === "string") ? j.detail : JSON.stringify(j.detail);
          } catch { }
          throw new Error(msg);
        }

        const data = await res.json();
        state.matches = data.matches || [];
        state.currentMatchIndex = 0;

        if (!state.matches.length) {
          setLoading(false);
          els.cardWrapper.innerHTML = `
    <div class="empty-state">
      <div style="font-weight:700; opacity:.9;">No matches found</div>
      <div style="margin-top:10px; opacity:.65; font-size:.95rem;">
        Try changing Region, Favorite Mode, Class, or Languages, then scan again.
      </div>

      <div style="margin-top:16px;">
        <button class="btn-primary" type="button" onclick="findMatches()">Scan again</button>
      </div>
    </div>
  `;
          return;
        }



        setLoading(false);
        renderCard();
      } catch (err) {
        console.error(err);
        showNetError();
        setLoading(false);
        showToast(err.message || "Could not fetch matches", "error");
      } finally {
        inFlight.match = false;
      }
    }

    function renderCard() {
      if (state.loading) return;

      if (!state.matches || state.currentMatchIndex >= state.matches.length) {
        els.cardWrapper.innerHTML = `
    <div class="empty-state">
      <div style="font-weight:700; opacity:.9;">No more matches</div>
      <div style="margin-top:10px; opacity:.65; font-size:.95rem;">
        Update your profile filters and click <b>Find Matches</b> again.
      </div>

      <div style="margin-top:16px;">
        <button class="btn-primary" type="button" onclick="findMatches()">Scan again</button>
      </div>
    </div>
  `;
        return;
      }



      const match = state.matches[state.currentMatchIndex];
      const p = match.profile;

      els.cardWrapper.innerHTML = `
    <div class="match-card" id="active-card">
      <div class="match-percent">${match.match_percent}% Match</div>
      <div class="avatar-lg">${getInitials(match.username)}</div>
      <div class="player-name">${p.display_username}</div>

      <div class="pill-container">
        <span class="info-pill">${p.region}</span>
        <span class="info-pill">${p.platform}</span>
        <span class="info-pill" style="color:var(--neon-green)">${p.class_type}</span>
        <span class="info-pill">${p.mic}</span>
      </div>

      <div class="match-reasons">
        <h4>Why this match:</h4>
        <ul>${match.reasons.map(r => `<li>${r}</li>`).join("")}</ul>
      </div>

      <div class="actions">
        <button class="action-btn btn-skip" onclick="handleSkip()">âœ•</button>
        <button class="action-btn btn-like" onclick="handleLike()">ğŸ’š</button>
      </div>
    </div>
  `;
    }

    function handleSkip() {
      if (state.loading) return;

      const card = document.getElementById("active-card");
      if (!card) return;

      card.classList.add("swipe-left");
      setTimeout(() => {
        state.currentMatchIndex++;
        renderCard();
      }, 300);
    }

    async function handleLike() {
      if (state.loading) return;
      if (inFlight.like) return;

      inFlight.like = true;

      const likeBtn = document.querySelector(".btn-like");
      const skipBtn = document.querySelector(".btn-skip");
      likeBtn?.setAttribute("disabled", true);
      skipBtn?.setAttribute("disabled", true);

      const card = document.getElementById("active-card");
      const matchUser = state.matches[state.currentMatchIndex];

      // Guard: Ø§Ú¯Ø± Ú©Ø§Ø±Øª/ÛŒÙˆØ²Ø± Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ù‚ÙÙ„ Ù†Ú©Ù†
      if (!matchUser) {
        likeBtn?.removeAttribute("disabled");
        skipBtn?.removeAttribute("disabled");
        inFlight.like = false;
        return;
      }

      // Optimistic UI
      if (card) card.classList.add("swipe-right");

      try {
        const res = await fetch(`${API_BASE}/like`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            from_user: state.profile.username,
            to_user: matchUser.username,
            game: GAME
          })
        });

        let data = null;
        try {
          data = await res.json();
        } catch {
          data = null;
        }

        if (!res.ok) {
          const msg =
            (data?.detail && (typeof data.detail === "string" ? data.detail : JSON.stringify(data.detail))) ||
            `Like failed: ${res.status}`;
          showToast(msg, "error");
          return;
        }

        // mutual
        if (data?.mutual === true || data?.status === "mutual") {
          await refreshSquad();

          const mate = (state.squad || []).find(
            m => (m.username || "").toLowerCase() === (matchUser.username || "").toLowerCase()
          );

          if (mate) triggerMatchModal(mate);
          else showToast("Matched, but could not load squadmate details yet.", "info");
        } else {
          await refreshSquad();
        }
      } catch (err) {
        console.error("Like failed", err);
        showNetError();
        showToast("Connection error sending like", "error");
      }

      setTimeout(() => {
        state.currentMatchIndex++;
        likeBtn?.removeAttribute("disabled");
        skipBtn?.removeAttribute("disabled");
        inFlight.like = false;
        renderCard();
      }, 300);
    }


    /* =========================================================
       SQUAD + STATUS
    ========================================================= */
    async function refreshSquad(opts = {}) {
      const silent = !!opts.silent;
      if (!state.profile.username) return;

      // Step 9E: prevent duplicate fetch/race
      if (inFlight.squad) return;

      inFlight.squad = true;
      try {
        const res = await fetch(
          `${API_BASE}/my-squad-details?username=${encodeURIComponent(state.profile.username)}&game=${GAME}`
        );
        if (!res.ok) throw new Error(`squad failed: ${res.status}`);

        const data = await res.json();
        const newSquad = data.squadmates || [];

        const sig = computeSquadSignature(newSquad);
        if (sig === lastSquadSignature) return;

        lastSquadSignature = sig;
        state.squad = newSquad;

        renderSquadList({ silent });
      } catch (err) {
        console.error("Squad fetch error", err);
        showNetError();
      } finally {
        inFlight.squad = false;
      }
    }


    function renderSquadList({ silent = false } = {}) {
      // silent ÙØ¹Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ ÙˆÙ„ÛŒ Ø§Ù…Ø¶Ø§ Ø¯Ø±Ø³Øª Ø§Ø³Øª
      els.squadList.innerHTML = "";

      if (!state.squad || state.squad.length === 0) {
        els.squadList.innerHTML =
          '<div class="empty-state" style="font-size: 0.9rem;">No squadmates yet. Start matching!</div>';
        return;
      }

      state.squad.forEach(mate => {
        const label = formatLastSeen(mate.last_active);

        const statusHtml =
          label === "Online"
            ? '<span class="status-badge status-online">Online</span>'
            : `<span class="status-badge status-offline">${label}</span>`;

        const item = document.createElement("div");
        item.className = "squad-member";
        item.innerHTML = `
      <div class="sm-avatar">${getInitials(mate.display_username)}</div>
      <div class="sm-info">
        <span class="sm-name">${mate.display_username || mate.username || ""}</span>
        <span class="sm-ign">In-game: ${mate.in_game_username || ""}</span>
      </div>
      ${statusHtml}
    `;
        els.squadList.appendChild(item);
      });
    }

    function formatLastSeen(lastActiveIso) {
      if (!lastActiveIso) return "Last seen: unknown";

      const lastMs = new Date(lastActiveIso).getTime();
      if (!Number.isFinite(lastMs)) return "Last seen: unknown";

      const diffSec = Math.floor((Date.now() - lastMs) / 1000);

      if (diffSec < 0) return "Last seen: now";
      if (diffSec <= 60) return "Online";

      const diffMin = Math.floor(diffSec / 60);
      if (diffMin < 60) return `Last seen ${diffMin}m ago`;

      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return `Last seen ${diffHr}h ago`;

      const diffDay = Math.floor(diffHr / 24);
      if (diffDay < 30) return `Last seen ${diffDay}d ago`;

      const diffYr = Math.floor(diffDay / 365);
      if (diffYr >= 1) return `Last seen ${diffYr}y ago`;

      const diffMon = Math.floor(diffDay / 30);
      return `Last seen ${diffMon}mo ago`;
    }

    /* =========================================================
       MODAL
    ========================================================= */
    function goToSquad() {
      closeModal();
      const panel =
        document.querySelector(".panel-squad") ||
        document.getElementById("squad-panel") ||
        document.getElementById("squad-list");
      if (panel) panel.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function triggerMatchModal(mate) {
      const meDisplay = state.profile.display_username || state.profile.username || "You";
      const meIGN = state.profile.in_game_username || "â€”";

      const mateDisplay = mate?.display_username || mate?.username || "User";
      const mateIGN = mate?.in_game_username || "â€”";

      document.getElementById("modal-me-avatar").textContent = getInitials(meDisplay);
      document.getElementById("modal-them-avatar").textContent = getInitials(mateDisplay);

      document.getElementById("modal-them-name").textContent = mateDisplay;
      document.getElementById("modal-me-name").textContent = meDisplay;
      document.getElementById("modal-me-ign").textContent = `In-game: ${meIGN}`;

      document.getElementById("modal-them-name-2").textContent = mateDisplay;
      document.getElementById("modal-them-ign").textContent = `In-game: ${mateIGN}`;

      els.modal.classList.add("active");
    }

    window.closeModal = function () {
      els.modal.classList.remove("active");
    };

    /* =========================================================
       META (REGION/MODE/LANG)
    ========================================================= */
    async function loadMeta() {
      const res = await fetch(`${API_BASE}/meta/${GAME}`);
      if (!res.ok) throw new Error(`meta failed: ${res.status}`);
      META = await res.json();
    }

    function populateRegions() {
      els.region.innerHTML = `<option value="">Select Region...</option>`;
      (META?.regions || []).forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.id;          // e.g. na-west
        opt.textContent = r.label; // e.g. North America West
        els.region.appendChild(opt);
      });

      els.city.innerHTML = `<option value="">Select City...</option>`;
      els.city.disabled = true;
    }

    function populateFavoriteModes() {
      els.favoriteMode.innerHTML = `<option value="">Fav Mode...</option>`;
      (META?.favorite_modes || []).forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        els.favoriteMode.appendChild(opt);
      });
    }

    function renderLanguagesFromMeta() {
      els.langContainer.innerHTML = "";
      (META?.languages || []).forEach(l => {
        const pill = document.createElement("div");
        pill.className = "lang-pill";
        pill.dataset.code = l.code;
        pill.textContent = l.label;

        pill.addEventListener("click", () => {
          pill.classList.toggle("active");
          updateStateLangsFromPills();
        });

        els.langContainer.appendChild(pill);
      });
    }

    function updateStateLangsFromPills() {
      const active = Array.from(els.langContainer.querySelectorAll(".lang-pill.active"));
      state.profile.languages = active.map(el => el.dataset.code);
    }

    function applyStoredLanguagesToPills() {
      const codes = new Set(state.profile.languages || []);
      els.langContainer.querySelectorAll(".lang-pill").forEach(p => {
        if (codes.has(p.dataset.code)) p.classList.add("active");
        else p.classList.remove("active");
      });
    }
  </script>
</body>

</html>